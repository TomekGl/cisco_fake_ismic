/** \file ismic.c
 *  \addtogroup ismic
 *
  * \author Tomasz GÅ‚uch, http://tomaszgluch.pl/
 * \date 2012-12-31
 */

#include "ismic.h"

/** Index of currently used bank */
volatile uint8_t bankNumber;

/** Pointer to currently read/written byte */
volatile uint8_t bankByteIndex;

/** Whether bank was choosen during transmission */
volatile uint8_t bankSet;

/** Bank 0, ISMIC version */
uint8_t bank_0[] = {
  0x01, 0x02 };

/** Bank 1 */
uint8_t bank_1[] = {
  0x53, 0xFF, 0xFF, 0xDA, 0x00, 0x00, 0xFF, 0x03,
  0xFF, 0xFF }; //5th byte - temp alarm

/** Bank 2 */
uint8_t bank_2[] = {
  0x00, 0x00, 0x00, 0x00 };

/** Bank 3, Rack Name */
uint8_t bank_3[] = {
  0x44, 0x65, 0x66, 0x61, 0x75, 0x6C, 0x74, 0x20,
  0x52, 0x61, 0x63, 0x6B, 0x20, 0x4E, 0x61, 0x6D,
  0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

/** Bank 4, Chassis Name */
uint8_t bank_4[] = {
  0x44, 0x65, 0x66, 0x61, 0x75, 0x6C, 0x74, 0x20,
  0x43, 0x68, 0x61, 0x73, 0x73, 0x69, 0x73, 0x20,
  0x4E, 0x61, 0x6D, 0x65, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

/** Bank 5 */
uint8_t bank_5[] = {
  0x2D, 0x6E, 0x6F, 0x6E, 0x65, 0x2D, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

/** Bank 6 */
uint8_t bank_6[] = {
  0x44, 0x65, 0x66, 0x61, 0x75, 0x6C, 0x74, 0x20,
  0x52, 0x55, 0x49, 0x44, 0x00, 0x00, 0x00, 0x00 };

/** Bank 7, Hostname */
uint8_t bank_7[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

/** Bank 8 */
uint8_t bank_8[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

/** Bank 9, Management URL */
uint8_t bank_9[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

/** Bank 10 */
uint8_t bank_10[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00 };

/** Bank 11 */
uint8_t bank_11[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00 };

/** Bank 12, Bay Number */
uint8_t bank_12[] = {
  0xFE};

/** Array of bank sizes */
uint8_t bank_size[] = {
		sizeof(bank_0),
		sizeof(bank_1),
		sizeof(bank_2),
		sizeof(bank_3),
		sizeof(bank_4),
		sizeof(bank_5),
		sizeof(bank_6),
		sizeof(bank_7),
		sizeof(bank_8),
		sizeof(bank_10),
		sizeof(bank_11),
		sizeof(bank_12),
};

/** Array of pointers to banks */
uint8_t *banks[] = {
		(uint8_t*)&bank_0,
		(uint8_t*)&bank_1,
		(uint8_t*)&bank_2,
		(uint8_t*)&bank_3,
		(uint8_t*)&bank_4,
		(uint8_t*)&bank_5,
		(uint8_t*)&bank_6,
		(uint8_t*)&bank_7,
		(uint8_t*)&bank_8,
		(uint8_t*)&bank_9,
		(uint8_t*)&bank_10,
		(uint8_t*)&bank_11,
		(uint8_t*)&bank_12,
};

/** \function BankCRC(uint8_t *bank, uint8_t len)
 * \param *bank Pointer to bank
 * \param len Lenght of bank (without checksum)
 * \brief Compute checksum of given byte sequence.
 *
 */
uint8_t BankCRC(uint8_t *bank, uint8_t len) {
	uint8_t i;
	uint8_t sum;
	sum = 0;
	for(i=0; i<len; i++) {
		sum-=bank[i];
	}
	i++;
	return sum;
}
